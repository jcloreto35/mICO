<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>mICO</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
    --bg: #000;
    --fg: #00ff00;
    --border: #00ff00;
}

body.light {
    --bg: #ffffff;
    --fg: #111111;
    --border: #cccccc;
}

body {
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: Consolas, monospace;
}

#app {
    display: flex;
    height: 100vh;
}

/* Sidebar */
#servers {
    width: 220px;
    border-right: 1px solid var(--border);
    padding: 10px;
}

#servers h3 {
    margin-top: 0;
}

#servers button {
    width: 100%;
    background: var(--bg);
    color: var(--fg);
    border: 1px solid var(--border);
    margin-bottom: 5px;
    cursor: pointer;
}

/* Chat */
#chat {
    flex: 1;
    display: flex;
    flex-direction: column;
}

#chatHeader {
    padding: 8px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#msgs {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
}

#input {
    display: flex;
    border-top: 1px solid var(--border);
}

input {
    background: var(--bg);
    color: var(--fg);
    border: none;
    outline: none;
    padding: 8px;
    font-family: Consolas, monospace;
}

#nick {
    width: 120px;
    border-right: 1px solid var(--border);
}

#msg {
    flex: 1;
}

/* Bot√£o tema */
#toggleTheme {
    background: none;
    border: 1px solid var(--border);
    color: var(--fg);
    cursor: pointer;
    padding: 2px 6px;
    font-size: 12px;
}
</style>
</head>

<body>

<div id="app">
    <!-- Servidores -->
    <div id="servers">
        <h3>Servidores</h3>
        <div id="listaServidores"></div>
        <hr>
        <button onclick="criarServidor()">+ Criar Servidor</button>
    </div>

    <!-- Chat -->
    <div id="chat">
        <div id="chatHeader">
            <span id="chatTitle">Nenhum servidor conectado</span>
            <button id="toggleTheme" title="Alternar tema">üåô</button>
        </div>
        <div id="msgs"></div>
        <div id="input">
            <input id="nick" placeholder="Nick">
            <input id="msg" placeholder="Mensagem">
        </div>
    </div>
</div>

<script>
// üî• CONFIG FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyC7LT9SoHNDu8KLxQ97Uax9olpAT0NdMZU",
    authDomain: "mico-d9a83.firebaseapp.com",
    databaseURL: "https://mico-d9a83-default-rtdb.firebaseio.com",
    projectId: "mico-d9a83",
    storageBucket: "mico-d9a83.firebasestorage.app",
    messagingSenderId: "83824148800",
    appId: "1:83824148800:web:adfa823352c15c61c93aa5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ELEMENTOS
const listaServidores = document.getElementById("listaServidores");
const msgsDiv = document.getElementById("msgs");
const msgInput = document.getElementById("msg");
const nickInput = document.getElementById("nick");
const chatTitle = document.getElementById("chatTitle");

// VARI√ÅVEIS
let servidorAtual = null;
let mensagensRef = null;
let nickTravado = false;
const userId = Date.now().toString();

// LISTAR SERVIDORES (ordenados por usu√°rios online)
db.ref("servidores").on("value", async snap => {
    listaServidores.innerHTML = "";
    const servidores = snap.val();
    if (!servidores) return;

    const lista = [];

    for (let id in servidores) {
        const servidor = servidores[id];

        const onlineSnap = await db.ref("usuariosOnline/" + id).once("value");
        const totalOnline = onlineSnap.exists()
            ? onlineSnap.numChildren()
            : 0;

        lista.push({ id, servidor, totalOnline });
    }

    lista.sort((a, b) => b.totalOnline - a.totalOnline);

    lista.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent =
            `${item.servidor.nome} (${item.totalOnline})` +
            (item.servidor.senha ? " üîí" : "");

        btn.onclick = () => entrarServidor(item.id, item.servidor);
        listaServidores.appendChild(btn);
    });
});

// ENTRAR NO SERVIDOR
function entrarServidor(id, servidor) {
    if (servidor.senha) {
        const senha = prompt("Senha do servidor:");
        if (btoa(senha) !== servidor.senha) {
            alert("Senha incorreta");
            return;
        }
    }

    // remove usu√°rio do servidor anterior
    if (servidorAtual) {
        db.ref(`usuariosOnline/${servidorAtual}/${userId}`).remove();
    }

    servidorAtual = id;
    chatTitle.textContent = "Servidor: " + servidor.nome;
    msgsDiv.innerHTML = "";

    // registra usu√°rio online
    const userOnlineRef = db.ref(`usuariosOnline/${id}/${userId}`);
    userOnlineRef.set({ nick: nickInput.value || "Anon" });
    userOnlineRef.onDisconnect().remove();

    if (mensagensRef) mensagensRef.off();

    mensagensRef = db.ref("mensagens/" + id);
    mensagensRef.limitToLast(100).on("child_added", snap => {
        const m = snap.val();
        addMsg(`[${m.hora}] <${m.nick}> ${m.texto}`);
    });

    // libera nick ao entrar
    nickTravado = false;
    nickInput.disabled = false;
}

// CRIAR SERVIDOR
function criarServidor() {
    const nome = prompt("Nome do servidor:");
    if (!nome) return;

    const senha = prompt("Senha (opcional):");

    db.ref("servidores").push({
        nome: nome,
        senha: senha ? btoa(senha) : null,
        criadoEm: Date.now()
    });
}

// ENVIAR MENSAGEM
msgInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && servidorAtual && msgInput.value.trim()) {

        if (!nickTravado) {
            nickInput.disabled = true;
            nickTravado = true;
        }

        db.ref("mensagens/" + servidorAtual).push({
            nick: nickInput.value || "Anon",
            texto: msgInput.value,
            hora: new Date().toLocaleString()
        });

        msgInput.value = "";
    }
});

// ADD MSG
function addMsg(text) {
    const div = document.createElement("div");
    div.textContent = text;
    msgsDiv.appendChild(div);
    msgsDiv.scrollTop = msgsDiv.scrollHeight;
}

// üåó TEMA
const toggleThemeBtn = document.getElementById("toggleTheme");

if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
    toggleThemeBtn.textContent = "‚òÄÔ∏è";
}

toggleThemeBtn.addEventListener("click", () => {
    document.body.classList.toggle("light");
    const isLight = document.body.classList.contains("light");
    localStorage.setItem("theme", isLight ? "light" : "dark");
    toggleThemeBtn.textContent = isLight ? "‚òÄÔ∏è" : "üåô";
});
</script>

</body>
</html>
